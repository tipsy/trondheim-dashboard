<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Test</title>
</head>
<body>
    <h1>Testing APIs for Persaunvegen 1C, 7045</h1>
    <div id="results"></div>

    <script>
        const resultsDiv = document.getElementById('results');

        async function testTrashAPI() {
            resultsDiv.innerHTML += '<h2>Testing Trash API...</h2>';

            try {
                // Test address search - API requires space before letter suffix and no trailing slash
                const searchResponse = await fetch('https://trv.no/wp-json/wasteplan/v2/adress?s=Persaunvegen 1 C');
                const searchData = await searchResponse.json();
                resultsDiv.innerHTML += `<p>✅ Address search: Found ${searchData.length} results</p>`;
                resultsDiv.innerHTML += `<pre>${JSON.stringify(searchData[0], null, 2)}</pre>`;
                
                if (searchData.length > 0) {
                    // Test calendar
                    const calendarResponse = await fetch(`https://trv.no/wp-json/wasteplan/v2/calendar/${searchData[0].id}`);
                    const calendarData = await calendarResponse.json();
                    resultsDiv.innerHTML += `<p>✅ Calendar: Found ${calendarData.calendar?.length || 0} entries</p>`;
                    resultsDiv.innerHTML += `<pre>${JSON.stringify(calendarData.calendar?.slice(0, 3), null, 2)}</pre>`;
                }
            } catch (error) {
                resultsDiv.innerHTML += `<p>❌ Trash API Error: ${error.message}</p>`;
            }
        }

        async function testBusAPI() {
            resultsDiv.innerHTML += '<h2>Testing Bus API...</h2>';
            
            try {
                // First geocode the address
                const geocodeResponse = await fetch('https://nominatim.openstreetmap.org/search?format=json&q=Persaunvegen 1C, 7045 Trondheim, Norway');
                const geocodeData = await geocodeResponse.json();
                
                if (geocodeData.length > 0) {
                    const lat = geocodeData[0].lat;
                    const lon = geocodeData[0].lon;
                    resultsDiv.innerHTML += `<p>✅ Geocoding: ${lat}, ${lon}</p>`;
                    
                    // Test nearest stops
                    const query = `
                        {
                            nearest(
                                latitude: ${lat}
                                longitude: ${lon}
                                maximumDistance: 1000
                                maximumResults: 5
                                filterByPlaceTypes: [stopPlace]
                            ) {
                                edges {
                                    node {
                                        place {
                                            ... on StopPlace {
                                                id
                                                name
                                                latitude
                                                longitude
                                            }
                                        }
                                        distance
                                    }
                                }
                            }
                        }
                    `;
                    
                    const busResponse = await fetch('https://api.entur.io/journey-planner/v3/graphql', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'ET-Client-Name': 'trondheim-dashboard'
                        },
                        body: JSON.stringify({ query })
                    });
                    
                    const busData = await busResponse.json();
                    
                    if (busData.errors) {
                        resultsDiv.innerHTML += `<p>❌ Bus API GraphQL Errors:</p>`;
                        resultsDiv.innerHTML += `<pre>${JSON.stringify(busData.errors, null, 2)}</pre>`;
                    } else {
                        const stops = busData.data?.nearest?.edges || [];
                        resultsDiv.innerHTML += `<p>✅ Nearest stops: Found ${stops.length} stops</p>`;
                        resultsDiv.innerHTML += `<pre>${JSON.stringify(stops.slice(0, 2), null, 2)}</pre>`;
                        
                        // Test departures for first stop
                        if (stops.length > 0) {
                            const stopId = stops[0].node.place.id;
                            const departuresQuery = `
                                {
                                    stopPlace(id: "${stopId}") {
                                        id
                                        name
                                        estimatedCalls(numberOfDepartures: 5, timeRange: 86400) {
                                            expectedDepartureTime
                                            realtime
                                            destinationDisplay {
                                                frontText
                                            }
                                            serviceJourney {
                                                line {
                                                    publicCode
                                                    transportMode
                                                }
                                            }
                                        }
                                    }
                                }
                            `;
                            
                            const departuresResponse = await fetch('https://api.entur.io/journey-planner/v3/graphql', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'ET-Client-Name': 'trondheim-dashboard'
                                },
                                body: JSON.stringify({ query: departuresQuery })
                            });
                            
                            const departuresData = await departuresResponse.json();
                            
                            if (departuresData.errors) {
                                resultsDiv.innerHTML += `<p>❌ Departures API GraphQL Errors:</p>`;
                                resultsDiv.innerHTML += `<pre>${JSON.stringify(departuresData.errors, null, 2)}</pre>`;
                            } else {
                                const departures = departuresData.data?.stopPlace?.estimatedCalls || [];
                                resultsDiv.innerHTML += `<p>✅ Departures: Found ${departures.length} departures</p>`;
                                resultsDiv.innerHTML += `<pre>${JSON.stringify(departures.slice(0, 2), null, 2)}</pre>`;
                            }
                        }
                    }
                }
            } catch (error) {
                resultsDiv.innerHTML += `<p>❌ Bus API Error: ${error.message}</p>`;
                console.error(error);
            }
        }

        // Run tests
        testTrashAPI().then(() => testBusAPI());
    </script>
</body>
</html>

